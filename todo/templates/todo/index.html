<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>To-Done</title>
    <meta name="referrer" content="strict-origin-when-cross-origin" />
    <link href="https://unpkg.com/tailwindcss@^2.2.19/dist/tailwind.min.css" rel="stylesheet">
</head>
<body>
    {% load todo_extras %}
    <div class="flex min-h-screen bg-gray-100">
        <!-- Sidebar -->
        <div class="w-64 bg-white shadow-lg">
            <div class="p-6">
                <!-- App Logo and Name -->
                <div class="flex items-center space-x-2 mb-8">
                    <svg class="w-8 h-8 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"></path>
                    </svg>
                    <h1 class="text-2xl font-bold text-gray-900">To-Done</h1>
                </div>
                <!-- New Todo List Section -->
                <div class="space-y-4">
                    <input type="text" 
                           id="todoListInput" 
                           placeholder="New Todo List" 
                           class="w-full px-4 py-2 text-gray-700 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    
                    <div class="text-sm font-medium text-gray-700">Select a tag for your todo list</div>
                    <select id="listTags" 
                            onchange="toggleNewTagInput()" 
                            class="w-full px-4 py-2 text-gray-700 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        {% for tag in list_tags %}
                        <option>{{ tag.tag_name }}</option>
                        {% endfor %}
                        <option selected>none</option>
                        <option value="new">--create new tag--</option>
                    </select>
                    
                    <input type="hidden" 
                           id="newListTag" 
                           placeholder="New List tag" 
                           class="w-full px-4 py-2 text-gray-700 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    
                    <input type="text" 
                           id="sharedUser" 
                           placeholder="Share this list with..." 
                           class="w-full px-4 py-2 text-gray-700 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    
                    <button onclick="newTodoList()" 
                            class="w-full flex justify-center py-2 px-4 border border-transparent text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                        Add List
                    </button>
                </div>

                <!-- Import/Export Section -->
                <div class="space-y-4 pt-6 border-t border-gray-200">
                    <a href="{% url 'todo:export_todo_csv' %}" 
                       class="block w-full text-center py-2 px-4 border border-transparent text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                        Export Lists
                    </a>
                    
                    <form method="POST" 
                          enctype="multipart/form-data" 
                          action="{% url 'todo:import_todo_csv' %}" 
                          class="space-y-3">
                        {% csrf_token %}
                        <label for="csvFile" 
                               class="block text-sm font-medium text-gray-700">
                            Import from CSV File:
                        </label>
                        <input type="file" 
                               id="csvFile" 
                               accept=".csv"
                               class="hidden" 
                               onchange="importFromCSV()">
                        <label for="csvFile" 
                               class="inline-block px-6 py-2 text-white bg-blue-600 rounded-md hover:bg-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 cursor-pointer">
                            Choose File
                        </label>
                        <button type="submit" 
                                class="w-full flex justify-center py-2 px-4 border border-transparent text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                            Import
                        </button>
                    </form>
                </div>
            </div>
        </div>

        <!-- Main Content Area -->
        <div class="flex-1">
            <!-- Top Navigation Bar -->
            <nav class="bg-white shadow-sm">
                <div class="px-4 h-16 flex items-center justify-end">
                    <a href="/logout" class="text-sm font-medium text-blue-600 hover:text-blue-500 flex items-center space-x-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path>
                        </svg>
                        <span>Logout</span>
                    </a>
                </div>
            </nav>
        
            <!-- Main Content -->
            <div class="p-6">

            {% for list in shared_list %}
            <div>
                <h2>
                    <a href="/todo/{{ list.id }}">{{ list.title_text }} 
                        {% if list.list_tag != "none" %}
                            <button type="button">{{ list.list_tag }}</button>
                        {% endif %}
                        <img src="https://cdn0.iconfinder.com/data/icons/multimedia-261/32/Send-512.png" 
                             title="This To-Do list is shared by {{ list.user_id }}" 
                             height="16" width="16">
                    </a>
                </h2>
                <form>
                    <div>
                        <label for="{{ "InputText_"|addstr:list.id }}">New Task</label>
                        <input type="text" id="{{ "InputText_"|addstr:list.id }}" 
                               class="w-full px-4 py-2 text-gray-700 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label for="{{ "InputDue_"|addstr:list.id }}">Due Date</label>
                        <input type="date" id="{{ "InputDue_"|addstr:list.id }}"
                               class="w-full px-4 py-2 text-gray-700 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label for="{{ "InputColor_"|addstr:list.id }}">Color Tag</label>
                        <div class="relative">
                            <input type="color" 
                                   id="{{ "InputColor_"|addstr:list.id }}" 
                                   value="#f9f9f9"
                                   class="w-full h-10 cursor-pointer appearance-none rounded-md border-2 border-white shadow-sm ring-1 ring-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500"
                                   style="background-color: #f9f9f9;">
                        </div>
                    </div>
                    <div>
                        <label for="{{ "InputPriority_"|addstr:list.id }}">Priority</label>
                        <select id="{{ "InputPriority_"|addstr:list.id }}" 
                                onchange="updatePriorityColor(this)"
                                class="w-full px-4 py-2 text-gray-700 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            <option value="" disabled selected>Priority (Medium default)</option>
                            <option value="HIGH" data-color="#fecaca">High Priority</option>
                            <option value="MEDIUM" data-color="#fde68a">Medium Priority</option>
                            <option value="LOW" data-color="#bbf7d0">Low Priority</option>
                        </select>
                    </div>
                </form>
                <div>
                    <button onclick="newElement({{ list.id }})">Add</button>
                </div>
                <ul id="{{ "List_"|addstr:list.id }}">
                    {% for list_item in latest_list_items %}
                        {% if list_item.list_id == list.id %}
                            <li class="flex items-center justify-between p-2 bg-gray-50 rounded-lg">
                                <div class="flex-grow">
                                    <div class="flex items-center space-x-3">
                                        <input type="checkbox" 
                                               id="ListItem_{{ list_item.id }}" 
                                               name="ListItem_{{ list_item.id }}" 
                                               value="ListItem_{{ list_item.id }}"
                                               {% if list_item.is_done %}checked{% endif %}
                                               onchange="markItemDone(this, {{ list_item.id }})"
                                               class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                        <label for="ListItem_{{ list_item.id }}" 
                                               class="{% if list_item.is_done %}line-through text-gray-500{% endif %} flex items-center space-x-2">
                                            <span class="text-lg">{{ list_item.item_name }}</span>
                                            <div class="w-3 h-3 rounded-full ml-2
                                                {% if list_item.priority == 'HIGH' %}bg-red-400
                                                {% elif list_item.priority == 'MEDIUM' %}bg-yellow-400
                                                {% else %}bg-green-400{% endif %}">
                                            </div>
                                        </label>
                                    </div>
                                    <div class="mt-1 text-xs text-gray-500 space-y-1 ml-6">
                                        {% if list_item.item_text %}
                                            <div class="item-note text-gray-600">{{ list_item.item_text }}</div>
                                        {% endif %}
                                        <div>Start date: {{ list_item.created_on|date:"M d, Y" }}</div>
                                        <div>Due: {% if list_item.due_date %}{{ list_item.due_date|date:"M d, Y" }}{% else %}Not set{% endif %}</div>
                                        {% if list_item.is_done == 1%}
                                            <div class="text-green-600">Completed in: {{ list_item.finished_on|timeuntil:list_item.created_on }}</div>
                                        {% endif %}
                                    </div>
                                </div>
                                <div class="flex items-center space-x-2 ml-4">
                                    <button class="edit-btn flex items-center text-blue-600 hover:text-blue-800" data-item-id="{{ list_item.id }}">
                                        <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path>
                                        </svg>
                                        Edit
                                    </button>
                                    <button class="delete-btn flex items-center text-red-600 hover:text-red-800" data-item-id="{{ list_item.id }}">
                                        <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                        </svg>
                                        Delete
                                    </button>
                                </div>
                            </li>
                        {% endif %}
                    {% endfor %}
                </ul>
                <form action="/templates/new-from-todo" method="post">
                    {% csrf_token %}
                    <input type="hidden" name="todo" id="todo-{{ list.id }}" value="{{ list.id }}">
                    <button>Save As Template</button>
                </form>
                <form action="/delete-todo" method="post">
                    {% csrf_token %}
                    <input type="hidden" name="todo" id="delete-todo-{{ list.id }}" value="{{ list.id }}">
                    <button>Delete</button>
                </form>
            </div>
        {% endfor %}

        {% for list in latest_lists %}
            <div class="w-full max-w-4xl bg-white rounded-lg shadow-lg p-6 mb-6">
                <div class="flex flex-col h-full">
                    <h2 class="flex items-center mb-4">
                        <a href="/todo/{{ list.id }}" class="text-2xl font-semibold text-blue-600 hover:text-blue-500">
                            {{ list.title_text }}
                            {% if list.list_tag != "none" %}
                                <span class="ml-2 px-3 py-1 text-sm bg-blue-100 text-blue-800 rounded-full">{{ list.list_tag }}</span>
                            {% endif %}
                            {% if list.is_shared == True %}
                                <img src="https://cdn0.iconfinder.com/data/icons/multimedia-261/32/Send-512.png" 
                                     title="This To-Do list is shared by you." 
                                     class="ml-2 h-4 w-4">
                            {% endif %}
                        </a>
                    </h2>
                    <form class="mb-4 space-y-4">
                        <div class="flex flex-col">
                            <label for="{{ "InputText_"|addstr:list.id }}" class="mb-1 text-sm font-medium text-gray-700">New Task</label>
                            <input type="text" id="{{ "InputText_"|addstr:list.id }}" 
                                   class="w-full px-4 py-2 text-gray-700 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div class="flex flex-col">
                            <label for="{{ "InputDue_"|addstr:list.id }}" class="mb-1 text-sm font-medium text-gray-700">Due Date</label>
                            <input type="date" id="{{ "InputDue_"|addstr:list.id }}"
                                   class="w-full px-4 py-2 text-gray-700 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div class="flex flex-col">
                            <label for="{{ "InputColor_"|addstr:list.id }}" class="mb-1 text-sm font-medium text-gray-700">Color Tag</label>
                            <input type="color" 
                                   id="{{ "InputColor_"|addstr:list.id }}" 
                                   value="#f9f9f9"
                                   style="-webkit-appearance: none; -moz-appearance: none; appearance: none; background-color: transparent; width: 100%; height: 40px; border: 2px solid white; border-radius: 6px; padding: 0; cursor: pointer; box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); outline: 1px solid #E5E7EB;"
                                   onchange="this.style.backgroundColor = this.value;"
                                   onclick="this.style.backgroundColor = this.value;">
                        </div>
                        <div class="flex flex-col">
                            <label for="{{ "InputPriority_"|addstr:list.id }}" class="mb-1 text-sm font-medium text-gray-700">Priority</label>
                            <select id="{{ "InputPriority_"|addstr:list.id }}" 
                                    onchange="updatePriorityColor(this)"
                                    class="w-full px-4 py-2 text-gray-700 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                <option value="" disabled selected>Priority (Medium default)</option>
                                <option value="HIGH" data-color="#fecaca">High Priority</option>
                                <option value="MEDIUM" data-color="#fde68a">Medium Priority</option>
                                <option value="LOW" data-color="#bbf7d0">Low Priority</option>
                            </select>
                        </div>
                    </form>
                    <div class="mb-4">
                        <button onclick="newElement({{ list.id }})" 
                                class="w-full bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                            Add Task
                        </button>
                    </div>
                    <ul id="{{ "List_"|addstr:list.id }}" class="space-y-3 flex-grow">
                        {% for list_item in latest_list_items %}
                            {% if list_item.list_id == list.id %}
                                <li class="flex items-center justify-between p-2 bg-gray-50 rounded-lg">
                                    <div class="flex-grow">
                                        <div class="flex items-center space-x-3">
                                            <input type="checkbox" 
                                                   id="ListItem_{{ list_item.id }}" 
                                                   name="ListItem_{{ list_item.id }}" 
                                                   value="ListItem_{{ list_item.id }}"
                                                   {% if list_item.is_done %}checked{% endif %}
                                                   onchange="markItemDone(this, {{ list_item.id }})"
                                                   class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                            <label for="ListItem_{{ list_item.id }}" 
                                                   class="{% if list_item.is_done %}line-through text-gray-500{% endif %} flex items-center space-x-2">
                                                <span class="text-lg">{{ list_item.item_name }}</span>
                                                <div class="w-3 h-3 rounded-full ml-2
                                                    {% if list_item.priority == 'HIGH' %}bg-red-400
                                                    {% elif list_item.priority == 'MEDIUM' %}bg-yellow-400
                                                    {% else %}bg-green-400{% endif %}">
                                                </div>
                                            </label>
                                        </div>
                                        <div class="mt-1 text-xs text-gray-500 space-y-1 ml-6">
                                            {% if list_item.item_text %}
                                                <div class="item-note text-gray-600">{{ list_item.item_text }}</div>
                                            {% endif %}
                                            <div>Start date: {{ list_item.created_on|date:"M d, Y" }}</div>
                                            <div>Due: {% if list_item.due_date %}{{ list_item.due_date|date:"M d, Y" }}{% else %}Not set{% endif %}</div>
                                            {% if list_item.is_done == 1%}
                                                <div class="text-green-600">Completed in: {{ list_item.finished_on|timeuntil:list_item.created_on }}</div>
                                            {% endif %}
                                        </div>
                                    </div>
                                    <div class="flex flex-col space-y-2 ml-4">
                                        <button class="edit-btn flex items-center text-blue-600 hover:text-blue-800" data-item-id="{{ list_item.id }}">
                                            <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path>
                                            </svg>
                                            Edit
                                        </button>
                                        <button class="delete-btn flex items-center text-red-600 hover:text-red-800" data-item-id="{{ list_item.id }}">
                                            <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                            </svg>
                                            Delete
                                        </button>
                                    </div>
                                </li>
                            {% endif %}
                        {% endfor %}
                    </ul>
                    <div class="mt-6 flex justify-end space-x-4">
                        <form action="/templates/new-from-todo" method="post">
                            {% csrf_token %}
                            <input type="hidden" name="todo" id="todo-{{ list.id }}" value="{{ list.id }}">
                            <button class="bg-green-600 text-white px-6 py-2 rounded-md hover:bg-green-500 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2">
                                Save As Template
                            </button>
                        </form>
                        <form action="/delete-todo" method="post">
                            {% csrf_token %}
                            <input type="hidden" name="todo" id="delete-todo-{{ list.id }}" value="{{ list.id }}">
                            <button class="bg-red-600 text-white px-6 py-2 rounded-md hover:bg-red-500 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2">
                                Delete List
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        {% endfor %}
        {% if not latest_lists %}
            {% if not shared_list %}
                <div>
                    <h2>You don't have any todo list!</h2>
                </div>
            {% endif %}
        {% endif %}
        {% if latest_lists or shared_list %}
            <div id="edit-sidebar" class="fixed top-0 right-0 h-full w-80 bg-white shadow-lg transform translate-x-full transition-transform duration-300 ease-in-out">
                <div class="p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-lg font-semibold">Edit Task</h2>
                        <button onclick="closeEditSidebar()" class="text-gray-500 hover:text-gray-700">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                            </svg>
                        </button>
                    </div>
                    <form id="edit-form" class="space-y-4">
                        <input type="hidden" id="edit-item-id">
                        
                        <div>
                            <label for="edit-title" class="block text-sm font-medium text-gray-700 mb-1">Title</label>
                            <input type="text" id="edit-title" 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-blue-500">
                        </div>

                        <div>
                            <label for="edit-note" class="block text-sm font-medium text-gray-700 mb-1">Note</label>
                            <textarea id="edit-note" rows="3" 
                                    class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-blue-500"></textarea>
                        </div>

                        <div>
                            <label for="edit-due-date" class="block text-sm font-medium text-gray-700 mb-1">Due Date</label>
                            <input type="date" id="edit-due-date" 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-blue-500">
                        </div>

                        <div>
                            <label for="edit-priority" class="block text-sm font-medium text-gray-700 mb-1">Priority</label>
                            <select id="edit-priority" 
                                    class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-blue-500"
                                    style="background-color: #fde68a;">
                                <option value="" disabled selected>Priority (Medium default)</option>
                                <option value="HIGH" style="background-color: #fecaca">High Priority</option>
                                <option value="MEDIUM" style="background-color: #fde68a">Medium Priority</option>
                                <option value="LOW" style="background-color: #bbf7d0">Low Priority</option>
                            </select>
                        </div>

                        <div class="flex items-center">
                            <input type="checkbox" id="edit-is-done" 
                                   class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                            <label for="edit-is-done" class="ml-2 block text-sm text-gray-700">Mark as completed</label>
                        </div>

                        <div class="pt-4">
                            <button type="submit" 
                                    class="w-full bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                                Save Changes
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        {% endif %}
    </div>

    <script>
    function editListItem(itemId) {
        const sidebar = document.getElementById('edit-sidebar');
        sidebar.classList.add('open');
        document.getElementById('edit-item-id').value = itemId;
        
        const httpRequest = new XMLHttpRequest();
        httpRequest.onreadystatechange = function() {
            if (this.readyState === 4) {
                if (this.status === 200) {
                    const response = JSON.parse(this.responseText);
                    document.getElementById('edit-title').value = response.item_name || '';
                    document.getElementById('edit-note').value = response.item_text || '';
                    document.getElementById('edit-due-date').value = response.due_date ? response.due_date.split('T')[0] : '';
                    document.getElementById('edit-priority').value = response.priority || '';
                    document.getElementById('edit-is-done').checked = response.is_done || false;
                } else {
                    console.error('Failed to fetch item details');
                    closeEditSidebar();
                }
            }
        };
        
        httpRequest.open('POST', '/getListItemById', true);
        httpRequest.setRequestHeader('Content-Type', 'application/json;charset=UTF-8');
        httpRequest.send(JSON.stringify({ list_item_id: itemId }));
    }

    function closeEditSidebar() {
        document.getElementById('edit-sidebar').classList.remove('open');
    }

    document.addEventListener('DOMContentLoaded', () => {
        document.querySelectorAll('.edit-btn').forEach(btn => {
            btn.addEventListener('click', () => editListItem(btn.dataset.itemId));
        });

        document.querySelectorAll('.delete-btn').forEach(btn => {
            btn.addEventListener('click', () => deleteListItem(btn.dataset.itemId));
        });
    });

    function deleteListItem(itemId) {
        if (!confirm('Are you sure you want to delete this task?')) {
            return;
        }

        const httpRequest = new XMLHttpRequest();
        httpRequest.onreadystatechange = function() {
            if (this.readyState === 4) {
                if (this.status === 200) {
                    // Find and remove the list item from the DOM
                    const listItem = document.querySelector(`[data-item-id="${itemId}"]`).closest('li');
                    
                    listItem.remove();
                } else {
                    alert('Failed to delete task. Please try again.');
                }
            }
        };

        httpRequest.open('POST', '/removeListItem', true);
        httpRequest.setRequestHeader('Content-Type', 'application/json;charset=UTF-8');
        httpRequest.send(JSON.stringify({
            list_item_id: itemId
        }));
    }

    // Initialize color inputs
    window.addEventListener('load', function() {
        document.querySelectorAll('input[type="color"]').forEach(input => {
            input.style.backgroundColor = input.value;
        });
    });

    // Click on a close button to hide the current list item
    var close = document.getElementsByClassName("close");
    var i;
    for (i = 0; i < close.length; i++) {
      close[i].onclick = removeListItem
    }

    function removeListItem() {
        // hide layout first
        var div = this.parentElement
        div.style.display = "none"

        // send post request to delete the actual list item
        var list_item_id = this.parentElement.getElementsByTagName("input")[0].id.toString().substring(9)
        var httpRequest = new XMLHttpRequest()
        httpRequest.open('POST', '/removeListItem');
        httpRequest.setRequestHeader('Content-Type', "application/json;charset=UTF-8")
        var params = {
            "list_item_id": list_item_id
        }
        httpRequest.send(JSON.stringify(params))
    }

    // When click a list item, restore all othe
    var list = document.getElementsByClassName("listItemsUnorderedList");
    for(let i = 0; i < list.length; i++) {
        list[i].addEventListener('click', function (ev) {
            if (ev.target.tagName === 'LI') {
                {#ev.target.classList.toggle('checked');#}
                // restore all other checked list items
                for(let k = 0; k < list.length; k++) {
                    for (let j = 0; j < list[k].children.length; j++) {
                        if (list[k].children[j].classList.contains('checked') && list[k].children[j] !== ev.target) {
                            list[k].children[j].classList.remove('checked')
                        }
                    }
                }
                // show list item name and its note in the right-side bar

                // TODO access database and get list and list item info
                var item_name = ev.target.children[1].innerHTML
                // ListItem_{id}, capture id start from index 9
                var item_id = ev.target.getElementsByTagName("input")[0].id.toString().substring(9)

                // this list id will look like List_{id}, so remove the first five letters
                var list_id = ev.target.parentElement.id.substring(5)
                var httpRequest = new XMLHttpRequest()
                {#httpRequest.onreadystatechange = alertContents;#}
                httpRequest.onreadystatechange = function() {
                  if (this.readyState === 4 && this.status === 200) {
                      console.log(this.responseText)
                      var jsonResponse = JSON.parse(this.responseText)
                      var rightsidebar = document.getElementById("rightsidebar")

                      var list_title_li_node = rightsidebar.children[0]
                      var list_text_node = list_title_li_node.children[0]
                      list_text_node.innerHTML = "List name: " + jsonResponse['list_name']

                      var item_title_li_node = rightsidebar.children[1]
                      var item_text_node = item_title_li_node.children[0]
                      item_text_node.innerHTML = "Item name: " + jsonResponse['item_name']

                      var item_form_node = rightsidebar.children[3]
                      var item_textarea_node = item_form_node.children[1]
                      item_textarea_node.value = jsonResponse['item_text']

                      // set the action url, append item id parameter to the end of url
                      var text_form = rightsidebar.getElementsByTagName("form")[0]
                      text_form.action = "/updateListItem/" + jsonResponse['item_id']
                    {#document.getElementById('demoGet').innerHTML = this.responseText;#}
                  }
                };
                httpRequest.open('POST', '/getListItemById');
                httpRequest.setRequestHeader('Content-Type', "application/json;charset=UTF-8")
                {#var token = {% csrf_token %}#}
                var params = {
                    "list_item_name": item_name,
                    "list_id": list_id,
                    "list_item_id": item_id,
                }
                httpRequest.send(JSON.stringify(params))


                // Change the content of right-side bar
                ev.target.classList.toggle('checked');
                {#global_count++#}
            }
        }, false);
    }

    var listItemsCheckBoxes = document.querySelectorAll("input[type=checkbox]");
    {#let enabledSettings = []#}
    /*
    For IE11 support, replace arrow functions with normal functions and
    use a polyfill for Array.forEach:
    https://vanillajstoolkit.com/polyfills/arrayforeach/
    */

    // mark item as done or undo it
    function markItemDone(checkbox, itemId) {
        const label = checkbox.parentElement.querySelector('label');
        const isChecked = checkbox.checked;
        
        const httpRequest = new XMLHttpRequest();
        httpRequest.onreadystatechange = function() {
            if (this.readyState === 4) {
                if (this.status === 200) {
                    if (isChecked) {
                        label.classList.add('line-through', 'text-gray-500');
                    } else {
                        label.classList.remove('line-through', 'text-gray-500');
                    }
                } else {
                    // Revert checkbox if request failed
                    checkbox.checked = !isChecked;
                    console.error('Failed to update task status');
                }
            }
        };
        
        httpRequest.open('POST', '/markListItem', true);
        httpRequest.setRequestHeader('Content-Type', 'application/json;charset=UTF-8');
        httpRequest.send(JSON.stringify({
            list_item_id: itemId,
            is_done: isChecked
        }));
    }
    
    // Handle form submission
    document.getElementById('edit-form').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const itemId = document.getElementById('edit-item-id').value;
        const title = document.getElementById('edit-title').value;
        const note = document.getElementById('edit-note').value;
        const dueDate = document.getElementById('edit-due-date').value;
        const priority = document.getElementById('edit-priority').value;
        const isDone = document.getElementById('edit-is-done').checked;
        
        const httpRequest = new XMLHttpRequest();
        httpRequest.onreadystatechange = function() {
            if (this.readyState === 4) {
                if (this.status === 200) {
                    const response = JSON.parse(this.responseText);
                    // Update the list item in the UI
                    const listItem = document.querySelector(`#ListItem_${itemId}`).closest('li');
                    
                    // Update title
                    const label = listItem.querySelector('label');
                    label.textContent = title;
                    if (isDone) {
                        label.classList.add('line-through', 'text-gray-500');
                    } else {
                        label.classList.remove('line-through', 'text-gray-500');
                    }
                    
                    // Update checkbox
                    const checkbox = listItem.querySelector('input[type="checkbox"]');
                    checkbox.checked = isDone;
                    
                    // Update note
                    let noteDisplay = listItem.querySelector('.item-note');
                    if (note) {
                        if (!noteDisplay) {
                            noteDisplay = document.createElement('div');
                            noteDisplay.className = 'item-note text-xs text-gray-600 ml-6';
                            const metadataDiv = listItem.querySelector('.text-gray-500');
                            metadataDiv.insertBefore(noteDisplay, metadataDiv.firstChild);
                        }
                        noteDisplay.textContent = note;
                    } else if (noteDisplay) {
                        noteDisplay.remove();
                    }
                    
                    // Update due date with consistent formatting
                    const dueDateElement = listItem.querySelector('.text-gray-500 div:nth-child(2)');
                    if (dueDate) {
                        const date = new Date(dueDate);
                        const formattedDate = date.toLocaleDateString('en-US', { 
                            month: 'short', 
                            day: 'numeric', 
                            year: 'numeric'
                        });
                        dueDateElement.textContent = `Due: ${formattedDate}`;
                    } else {
                        dueDateElement.textContent = 'Due: Not set';
                    }
                    
                    closeEditSidebar();
                } else {
                    alert('Failed to update task. Please try again.');
                }
            }
        };
        
        httpRequest.open('POST', `/updateListItem/${itemId}`, true);
        httpRequest.setRequestHeader('Content-Type', 'application/json;charset=UTF-8');
        httpRequest.send(JSON.stringify({
            title: title,
            note: note,
            due_date: dueDate,
            priority: priority,
            is_done: isDone
        }));
    })
    
    // Use Array.forEach to add an event listener to each checkbox.
    listItemsCheckBoxes.forEach(function(checkbox) {
      checkbox.addEventListener('change', markItemDone)
    });


    // The naming convention of List is "List_" + list.id
    // The naming convention of ListItem is "ListItem_" + list_item.id
    // Create a new list item when clicking on the "Add" button
    function newElement(list_id, saved_to_database = true) {
        var li = document.createElement("li");
        {#var inputBox = document.getElementById(list_id).parentElement.getElementsByTagName("input")[0]#}
        var inputBox = document.getElementById("InputText_" + list_id.toString());
        var inputValue = inputBox.value;
        var inputDue = document.getElementById("InputDue_" + list_id.toString()).value;
        var inputColor = document.getElementById("InputColor_" + list_id.toString()).value;
        var inputPriority = document.getElementById("InputPriority_" + list_id.toString()).value;
        // var unorderedList = inputBox.parentElement.nextElementSibling

        {#var list_html_tag_id =  #}

        li.className = "listItem";
        if (inputValue === '') {
            alert("You must write something!");
        }
        else if (inputDue === '') {
            alert("You must enter due date!")
        }
        // else {
        //     unorderedList.appendChild(li);
        // }
        inputBox.value = "";

        // Saved to database if saved_to_database is true
        if(saved_to_database && inputValue !== '') {
            var httpRequest = new XMLHttpRequest()
            var today = new Date()
            var create_on_timestamp = today.getTime() / 1000
            httpRequest.onreadystatechange = function() {
                if (this.readyState === 4 && this.status === 200) {
                    // get the newly created item's id and set it as the id of the html tag
                    // add checkbox element
                    var jsonResponse = JSON.parse(this.responseText)
                    var itemCheckBox = document.createElement("input")
                    itemCheckBox.type = "checkbox"
                    // id and name should be unique, currently I set it to be list_name + item_name
                    var itemValue = "ListItem_" + jsonResponse['item_id']
                    itemCheckBox.id = itemValue
                    itemCheckBox.name = itemValue
                    itemCheckBox.value = itemValue
                    itemCheckBox.addEventListener('change', markItemDone)

                    var itemLabel = document.createElement("label")
                    itemLabel.htmlFor  = itemValue
                    itemLabel.innerHTML = inputValue
                    li.append(itemCheckBox)
                    li.append(itemLabel)

                    var span = document.createElement("SPAN");
                    var txt = document.createTextNode("\u00D7");
                    span.className = "close";
                    span.onclick = removeListItem
                    span.appendChild(txt);
                    li.appendChild(span);
                }
            };
            httpRequest.open('POST', '/addNewListItem');
            httpRequest.setRequestHeader('Content-Type', "application/json;charset=UTF-8")
            var params = {
                "list_id": list_id,
                "list_item_name": inputValue,
                "create_on": create_on_timestamp,
                "due_date": inputDue,
                "tag_color": inputColor,
                "priority": inputPriority
            }
            httpRequest.send(JSON.stringify(params))
        }
        window.location.reload();
        {#else {#}
        {#    return#}
        {#}#}

        {#for (i = 0; i < close.length; i++) {#}
        {#    close[i].onclick = removeListItem#}
        {#}#}
    }

    function newTodoList() {
        var li = document.createElement("li")
        var li_a = document.createElement("a")
        var leftSideBar = document.getElementById("todoListInput")
        var selectedTag = document.getElementById("listTags").value;
        var listTag = selectedTag;
        var create_new_tag = false;
        var sharedUser = document.getElementById("sharedUser").value;

        if(selectedTag==='new'){
            listTag = document.getElementById("newListTag").value;
            create_new_tag = true;
        }
        var listTag = selectedTag==='new'? document.getElementById("newListTag").value : selectedTag;
        var inputValue = leftSideBar.value
        if (inputValue === '') {
            alert("You must write something!")
        }
        else if(listTag === ''){
            alert("Select a tag");
        }
        else {
            // add new to-do list to the
            li_a.innerHTML = inputValue
            li.appendChild(li_a)

            leftSideBar.insertBefore(li, leftSideBar.children[leftSideBar.children.length - 1]);
            var today = new Date()
            var create_on_timestamp = today.getTime() / 1000
            // TODO Save new todo list to database
            var httpRequest = new XMLHttpRequest()
            // {#httpRequest.onreadystatechange = alertContents;#}
            httpRequest.open('POST', '/createNewTodoList');
            httpRequest.setRequestHeader('Content-Type', "application/json;charset=UTF-8")
            // {#var token = {% csrf_token %}#}
            var params = {
                "list_name": inputValue,
                "create_on": create_on_timestamp,
                "list_tag": listTag,
                "create_new_tag": create_new_tag,
                "shared_user": sharedUser,
            }

            // httpRequest.responseType = 'text';

            if (httpRequest.readyState === httpRequest.DONE){
                if (httpRequest.status == 200) {
                    console.log("The request has been made");
                }
            }

            httpRequest.send(JSON.stringify(params))

            window.location.reload();
        }
    }

    function toggleNewTagInput() {
        var x = document.getElementById("listTags").value
        if(x === 'new'){
            document.getElementById("newListTag").type='text';
        }else{
            document.getElementById("newListTag").type='hidden';
        }
    }

    function importFromCSV(){
        httpRequest.open('POST', '/import_todo_csv');
    }

    function updatePriorityColor(selectElement) {
        const selectedOption = selectElement.options[selectElement.selectedIndex];
        const color = selectedOption.getAttribute('data-color');
        selectElement.style.backgroundColor = color || '#fde68a'; // Default to medium priority color
    }

    // Initialize priority dropdowns with correct colors
    document.addEventListener('DOMContentLoaded', function() {
        document.querySelectorAll('select[id^="InputPriority_"]').forEach(select => {
            updatePriorityColor(select);
        });
    });
    </script>
    <style>
    #edit-sidebar {
        z-index: 1000;
        border-left: 1px solid #e5e7eb;
        position: fixed;
        top: 0;
        right: 0;
        width: 400px;
        height: 100vh;
        background-color: white;
        padding: 2rem;
        transform: translateX(100%);
        transition: transform 0.3s ease-in-out;
    }
    
    #edit-sidebar.open {
        transform: translateX(0);
    }
    
    .edit-btn {
        display: flex;
        align-items: center;
    }
    
    .close {
        cursor: pointer;
        font-size: 1.5rem;
        color: #9CA3AF;
    }
    
    .close:hover {
        color: #EF4444;
    }
    </style>
</body>
</html>
